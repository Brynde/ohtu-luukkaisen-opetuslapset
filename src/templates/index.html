{% extends "layout.html" %}

{% block title %}Omat lähteet{% endblock %}

{% block header %}Omat lähteet{% endblock %}

{% block messages %}{{ super () }}{% endblock %}

{% block body %}

<a href="/sources/new" class="add-button" id="new_source">+ Lisää uusi lähde</a>

<form action="/sources/find_source" method="get">
        <p>
            <label for="query">Hae viitteitä:</label><br><br>
            <input type="text" name="query" value="{{ query }}">
        </p>

        <p>
            <label for="ref_type">Tyyppi:</label><br>
            <select name="ref_type">
                <option value="">Kaikki</option>
                <option value="book" {% if ref_type == 'book' %}selected{% endif %}>kirja</option>
                <option value="inproceedings" {% if ref_type == 'inproceedings' %}selected{% endif %}>konferenssiartikkeli</option>
                <option value="article" {% if ref_type == 'article' %}selected{% endif %}>artikkeli</option>
            </select>
        </p>
        <input type="submit" value="Hae">
    </form><br><br>

{% if sources %}
    {% for source in sources %}
        <div class="source-card">
            <h3>{{ source.title }}</h3>
            <p><strong>Kirjoittaja(t):</strong> {{ source.author }}</p>
            <p><strong>Lähteen tyyppi:</strong>
            {% if source.ref_type == 'book' %}
                kirja
            {% elif source.ref_type == 'inproceedings' %}
                konferenssiartikkeli
            {% elif source.ref_type == 'article' %}
                artikkeli
            {% else %}
                {{ source.ref_type }}
            {% endif %}
            </p>
            <p><strong>Vuosi:</strong> {{ source.year }}</p>
            {% if source.journal or source.publisher %}
            <p><strong>Julkaisu / Kustantaja:</strong> 
                {{ source.journal if source.journal else source.publisher }}</p>
            {% endif %}
            
            <br>
            <h3>BibTeX koodi:</h3>
            <div class="bib-controls">
            <button type="button" class="toggle-bib" data-target="bib-{{ source.key }}">Näytä BibTeX</button>
            <button type="button" class="copy-bib" data-target="bib-{{ source.key }}">Kopioi</button>
            </div>
            <pre id="bib-{{ source.key }}" class="bibcode" style="display:none; white-space: pre-wrap;">{{ source.bibtex }}</pre>

        <div class="buttons">
            <button class="edit-btn"><a class="edit-btn" href="{{ url_for('edit_source', source_key=source.key) }}">Muokkaa</a></button>
            <form action="{{ url_for('delete_source', source_key=source.key) }}" method="post" style="display:inline">
                <button class="delete-btn" type="submit"><a class="delete-btn">Poista</a></button>
            </form>
        </div>
        </div>
    {% endfor %}
{% else %}
    <p>Lähteitä ei löytynyt. Lisää uusi viite yläpuolelta!</p>
{% endif %}

<script>
document.addEventListener('click', (e) => {
  if (e.target.matches('.toggle-bib')) {
    const id = e.target.dataset.target;
    const el = document.getElementById(id);
    const shown = el.style.display !== 'none';
    el.style.display = shown ? 'none' : 'block';
    e.target.textContent = shown ? 'Näytä BibTeX' : 'Piilota BibTeX';
  }

  if (e.target.matches('.copy-bib')) {
    const id = e.target.dataset.target;
    const el = document.getElementById(id);
    const text = el ? el.textContent : '';
    if (!text) return;

    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text).then(() => {
        const old = e.target.textContent;
        e.target.textContent = 'Kopioitu!';
        setTimeout(() => e.target.textContent = old, 1500);
      }).catch(() => fallbackCopy(text, e));
    } else {
      fallbackCopy(text, e);
    }
  }
});
function fallbackCopy(text, buttonEventTarget) {
  const ta = document.createElement('textarea');
  ta.value = text;
  ta.style.position = 'fixed';
  ta.style.left = '-9999px';
  document.body.appendChild(ta);
  ta.select();
  try {
    document.execCommand('copy');
    const old = buttonEventTarget.target ? buttonEventTarget.target.textContent : buttonEventTarget.textContent;
    (buttonEventTarget.target || buttonEventTarget).textContent = 'Kopioitu!';
    setTimeout(() => (buttonEventTarget.target || buttonEventTarget).textContent = old, 1500);
  } finally {
    document.body.removeChild(ta);
  }
}
</script>


{% endblock %}