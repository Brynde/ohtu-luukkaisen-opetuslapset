{% extends "layout.html" %}

{% block body %}
  {% block options %}{% endblock %}

  <div class="cards">
    {% block source_cards %}
      {% for source in sources %}
        <div class="source-card">
          <h3>{{ source.title }}</h3>
          <p><strong>Kirjoittaja(t):</strong> {{ source.author }}</p>
          <p><strong>Lähteen tyyppi:</strong>
            {% if source.ref_type == 'book' %}kirja
            {% elif source.ref_type == 'inproceedings' %}konferenssiartikkeli
            {% elif source.ref_type == 'article' %}artikkeli
            {% else %}{{ source.ref_type }}{% endif %}
          </p>
          <p><strong>Vuosi:</strong> {{ source.year }}</p>
          {% if source.journal or source.publisher %}
            <p><strong>Julkaisu / Kustantaja:</strong> {{ source.journal if source.journal else source.publisher }}</p>
          {% endif %}
          {% if source.doi %}
            <p><strong>DOI:</strong></p>
            <button type="button" class="doi-button" data-target="doi-{{ source.key }}">Näytä DOI</button>
            <pre id="doi-{{ source.key }}" class="code" style="display:none;">
              <p>{{ source.doi }}</p>
            </pre>
          {% endif %}
          <h3>BibTeX koodi:</h3>
          <div class="bib-controls">
            <button type="button" class="misc-button" data-target="bib-{{ source.key }}">Näytä BibTeX</button>
            <button type="button" class="copy-button" data-target="bib-{{ source.key }}">Kopioi</button>
          </div>
          <pre id="bib-{{ source.key }}" class="code" style="display:none; white-space: pre-wrap;">
            <p>{{ source.bibtex }}</p>
          </pre>
          <div class="buttons">
            <a href="{{ url_for('edit_source', source_key=source.key) }}" class="edit-btn">Muokkaa</a>
            <form action="{{ url_for('delete_source', source_key=source.key) }}" method="post" style="display:inline;">
              <button class="delete-btn" type="submit"
                onclick="return confirm('Haluatko varmasti poistaa tämän lähteen?')">Poista</button>
            </form>
          </div>
        </div>
      {% endfor %}
    {% endblock %}
  </div>
{% endblock %}

<script>
document.addEventListener('click', (e) => {
  if (e.target.matches('.misc-button')) {
    const id = e.target.dataset.target;
    const el = document.getElementById(id);
    const shown = el && el.style.display !== 'none';
    if (!el) return;
    el.style.display = shown ? 'none' : 'block';
    e.target.textContent = shown ? 'Näytä BibTeX' : 'Piilota BibTeX';
  }
  if (e.target.matches('.copy-button')) {
    const id = e.target.dataset.target;
    const el = document.getElementById(id);
    const text = el ? el.textContent : '';
    if (!text) return;
    if (navigator.clipboard) {
      navigator.clipboard.writeText(text).then(() => {
        const old = e.target.textContent;
        e.target.textContent = 'Kopioitu!';
        setTimeout(() => e.target.textContent = old, 1500);
      });
    }
  }
  if (e.target.matches('.doi-button')) {
    const id = e.target.dataset.target;
    const el = document.getElementById(id);
    const shown = el && el.style.display !== 'none';
    if (!el) return;
    el.style.display = shown ? 'none' : 'block';
    e.target.textContent = shown ? 'Näytä DOI' : 'Piilota DOI';
  }
});
</script>
