{% extends "layout.html" %}

{% block title %}Etsi viite{% endblock %}

{% block header %}Etsi viite{% endblock %}

{% block messages %}{{ super () }}{% endblock %}

{% block body %}

    <form action="/sources/find_source" method="get">
            <p>
                <label for="query">Hae viitteitä:</label><br><br>
                <input type="text" name="query" value="{{ query }}">
            </p>

            <p>
                <label for="ref_type">Tyyppi:</label><br>
                <select name="ref_type">
                    <option value="">Kaikki</option>
                    <option value="book" {% if ref_type == 'book' %}selected{% endif %}>kirja</option>
                    <option value="inproceedings" {% if ref_type == 'inproceedings' %}selected{% endif %}>konferenssiartikkeli</option>
                    <option value="article" {% if ref_type == 'article' %}selected{% endif %}>artikkeli</option>
                </select>
            </p>
            <input type="submit" value="Hae">
        </form><br><br>

    <a href="/">Palaa etusivulle</a>
    <h2>Hakutulokset</h2>

        {% if sources %}
            {% for source in sources %}
                <div class="source-card">
                    <h3>{{ source.title }}</h3>
                    <p><strong>Kirjoittaja(t):</strong> {{ source.author }}</p>
                    <p><strong>Lähteen tyyppi:</strong>
                    {% if source.ref_type == 'book' %}
                        kirja
                    {% elif source.ref_type == 'inproceedings' %}
                        konferenssiartikkeli
                    {% elif source.ref_type == 'article' %}
                        artikkeli
                    {% else %}
                        {{ source.ref_type }}
                    {% endif %}
                    </p>
                    <p><strong>Vuosi:</strong> {{ source.year }}</p>
                    {% if source.journal or source.publisher %}
                    <p><strong>Julkaisu / Kustantaja:</strong> 
                        {{ source.journal if source.journal else source.publisher }}</p>
                    {% endif %}

                    {# DOI-nappi + piilotettu DOI, vain jos doi on olemassa #}
                    {% if source.doi %}
                    <p>
                        <strong>DOI:</strong>
                        <button type="button" class="toggle-doi" data-target="doi-{{ source.key }}">Näytä DOI</button>
                    </p>
                    <p id="doi-{{ source.key }}" class="doicode" style="display:none; white-space: pre-wrap;">
                        {{ source.doi }}
                    </p>
                    {% endif %}

                    <p><strong>Tagit:</strong>
                        {% if source.tags %}
                            {% for tag in source.tags %}
                                <span class="tag">{{ tag }}</span>{% if not loop.last %}, {% endif %}
                            {% endfor %}
                        {% else %}
                            <em>ei tageja</em>
                        {% endif %}
                    </p>



                    <br>
                    <h3>BibTeX koodi:</h3>
                    <div class="bib-controls">
                    <button type="button" class="toggle-bib" data-target="bib-{{ source.key }}">Näytä BibTeX</button>
                    <button type="button" class="copy-bib" data-target="bib-{{ source.key }}">Kopioi</button>
                    </div>
                     <pre id="bib-{{ source.key }}" class="bibcode" style="display:none; white-space: pre-wrap;">{{ source.bibtex }}</pre>
                    <div class="buttons">
                        <button class="edit-btn"><a href="{{ url_for('edit_source', source_key=source.key) }}">Muokkaa</a></button>
                        <form action="{{ url_for('delete_source', source_key=source.key) }}" method="post" style="display:inline">
                            <button class="delete-btn" type="submit"
                                    onclick="return confirm('Haluatko varmasti poistaa tämän lähteen?')">
                                Poista
                            </button>
                        </form>
                    </div>
                    </div>
            {% endfor %}
        {% else %}
            <p>Ei tuloksia {% if query %} hakusanalla: "{{ query }}" {% endif %} {% if query and ref_type %} ja {% endif %} {% if ref_type %} tyypillä: "{{ ref_type }}" {% endif %} </p>
        {% endif %}
<script>
document.addEventListener('click', (e) => {
  if (e.target.matches('.toggle-bib')) {
    const id = e.target.dataset.target;
    const el = document.getElementById(id);
    const shown = el.style.display !== 'none';
    el.style.display = shown ? 'none' : 'block';
    e.target.textContent = shown ? 'Näytä BibTeX' : 'Piilota BibTeX';
  }

  if (e.target.matches('.copy-bib')) {
    const id = e.target.dataset.target;
    const el = document.getElementById(id);
    const text = el ? el.textContent : '';
    if (!text) return;

    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text).then(() => {
        const old = e.target.textContent;
        e.target.textContent = 'Kopioitu!';
        setTimeout(() => e.target.textContent = old, 1500);
      }).catch(() => fallbackCopy(text, e));
    } else {
      fallbackCopy(text, e);
    }
  }
});
function fallbackCopy(text, buttonEventTarget) {
  const ta = document.createElement('textarea');
  ta.value = text;
  ta.style.position = 'fixed';
  ta.style.left = '-9999px';
  document.body.appendChild(ta);
  ta.select();
  try {
    document.execCommand('copy');
    const old = buttonEventTarget.target ? buttonEventTarget.target.textContent : buttonEventTarget.textContent;
    (buttonEventTarget.target || buttonEventTarget).textContent = 'Kopioitu!';
    setTimeout(() => (buttonEventTarget.target || buttonEventTarget).textContent = old, 1500);
  } finally {
    document.body.removeChild(ta);
  }
}
</script>
{% endblock %}