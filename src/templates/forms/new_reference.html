{% extends "forms/base.html" %}

{% block title %}Lisää uusi viite{% endblock %}

{% block page_header %}
<div class="forms">
  <h2 class="page-title">Lisää uusi viite</h2>
</div>
{% endblock %}

{% block messages %}{{ super () }}{% endblock %}

{% block body %}

<div class="forms">
<div class="source-card">
<form method="POST">

    <p class="required">* merkityt kentät ovat pakollisia </p>
    <label for="key">Viiteavain (key): <span class="required">*</span></label><br>
    <input type="text" class="text-field" id="key" name="key" required
            value="{{ request.form.get('key', '') }}"><br><br>

    <label for="ref_type">Tyyppi: <span class="required">*</span></label><br>
    <select id="ref_type" class="text-field" name="ref_type" required>
        <option value="article"
            {% if request.form.get('ref_type', 'article') == 'article' %}selected{% endif %}>
            artikkeli
        </option>
        <option value="book"
            {% if request.form.get('ref_type') == 'book' %}selected{% endif %}>
            kirja
        </option>
        <option value="inproceedings"
            {% if request.form.get('ref_type') == 'inproceedings' %}selected{% endif %}>
            konferenssiartikkeli
        </option>
    </select><br><br>

    <label for="author">Tekijä(t): <span class="required">*</span></label><br>
    <input type="text" class="text-field" id="author" name="author" required
            value="{{ request.form.get('author', '') }}"><br><br>

    <label for="title">Otsikko (title): <span class="required">*</span></label><br>
    <input type="text" class="text-field" id="title" name="title" required
            value="{{ request.form.get('title', '') }}"><br><br>

    <label for="year">Vuosi (year): <span class="required">*</span></label><br>
    <input type="number" class="text-field" id="year" name="year" required
            value="{{ request.form.get('year', '') }}"><br><br>

    <label for="journal">Lehti / Konferenssi (journal/booktitle):</label><br>
    <input type="text" class="text-field" id="journal" name="journal"
            value="{{ request.form.get('journal', '') }}"><br><br>

    <label for="publisher">Kustantaja (publisher):</label><br>
    <input type="text" class="text-field" id="publisher" name="publisher"
           value="{{ request.form.get('publisher', '') }}"><br><br>

    <label for="tags">Tunnisteet:</label><br>
    <div class="tags-dropdown">
    <button type="button" class="text-field" id="tags-toggle">Valitse tunnisteet ▾</button>
    <div id="tags-panel" class="hidden panel">
        <div class="tags-list" style="max-height:200px;overflow:auto;">
        {% for t in tags|default([]) %}
            <label style="display:block;padding:2px">
            <input type="checkbox" name="tags" value="{{ t }}"
                    {% if t in request.form.getlist('tags') %}checked{% endif %}>
            {{ t }}
            </label>
        {% endfor %}
        </div>
        <hr>
        <label for="new_tags">Lisää uusia tunnisteita (erota pilkulla tai rivinvaihdolla):</label><br>
        <textarea id="new_tags" name="new_tags" rows="3" style="width:100%">{{ request.form.get('new_tags','') }}</textarea>
        <div style="margin-top:6px;font-size:0.9em;color:#555">Valitse olemassa olevat tai lisää uusia. Uudet tunnisteet luodaan lomakkeen lähetyksessä.</div>
        </div>
    </div>
    <br>

    <label for="doi">DOI:</label><br>
    <input type="text" class="text-field" id="doi" name="doi"
           value="{{ request.form.get('doi', '') }}"><br><br>

    <button type="submit" class="misc-button">Tallenna viite</button>
</form>
</div>

<p>
    <a class="add-button" href="/">Palaa etusivulle</a>
</p>
</div>
<script>
document.addEventListener('DOMContentLoaded', function () {
  const toggle = document.getElementById('tags-toggle');
  const panel = document.getElementById('tags-panel');
  if (!toggle || !panel) return;
  toggle.addEventListener('click', () => panel.classList.toggle('hidden'));
  // close panel on outside click
  document.addEventListener('click', (e) => {
    if (!panel.contains(e.target) && e.target !== toggle) panel.classList.add('hidden');
  });
});
</script>

{% endblock %}

{% block options %}{{ super() }}{% endblock %}